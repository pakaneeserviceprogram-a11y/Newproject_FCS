/* --- PART 3: SECURITY & BACK OFFICE --- */
CREATE TABLE App_Permissions (
    PermissionCode NVARCHAR(50) PRIMARY KEY, Description NVARCHAR(100), Category NVARCHAR(50)
);

CREATE TABLE App_Roles (
    RoleID INT IDENTITY(1,1) PRIMARY KEY, RoleName NVARCHAR(50) UNIQUE, Description NVARCHAR(100), IsSystemRole BIT DEFAULT 0
);

CREATE TABLE App_Role_Permissions (
    RoleID INT REFERENCES App_Roles(RoleID), PermissionCode NVARCHAR(50) REFERENCES App_Permissions(PermissionCode),
    PRIMARY KEY (RoleID, PermissionCode)
);

CREATE TABLE App_Users (
    UserID INT IDENTITY(1,1) PRIMARY KEY, Username NVARCHAR(50) UNIQUE, IsADUser BIT DEFAULT 0,
    PasswordHash NVARCHAR(255), RelatedVendorID NVARCHAR(20), IsActive BIT DEFAULT 1
);

CREATE TABLE App_User_Roles (
    UserID INT REFERENCES App_Users(UserID), RoleID INT REFERENCES App_Roles(RoleID), PRIMARY KEY (UserID, RoleID)
);

CREATE TABLE App_Menus (
    MenuID INT IDENTITY(1,1) PRIMARY KEY, ParentMenuID INT REFERENCES App_Menus(MenuID),
    MenuName_TH NVARCHAR(100), MenuName_EN NVARCHAR(100), IconClass NVARCHAR(50),
    RoutePath NVARCHAR(100), SortOrder INT DEFAULT 0,
    RequiredPermissionCode NVARCHAR(50) REFERENCES App_Permissions(PermissionCode), IsActive BIT DEFAULT 1
);

/* --- PART 4: WELFARE & PROMOTION --- */
CREATE TABLE Subsidy_Rules (
    RuleID INT IDENTITY(1,1) PRIMARY KEY, RuleName NVARCHAR(100) NOT NULL,
    CardGroupID NVARCHAR(20) REFERENCES Card_Groups(CardGroupID), -- ต้องมี Group ก่อน Insert
    FrequencyType NVARCHAR(20) DEFAULT 'DAILY', ExecutionDay INT DEFAULT 0,
    Amount DECIMAL(12, 2) NOT NULL, TopUpMode NVARCHAR(20) DEFAULT 'RESET', -- RESET=ล้างเก่าเติมใหม่, STACK=ทบยอด
    IsActive BIT DEFAULT 1, LastRunDate DATE NULL
);

CREATE TABLE Txn_Subsidy_Log (
    LogID BIGINT IDENTITY(1,1) PRIMARY KEY, TxnDate DATETIME DEFAULT GETDATE(),
    CardUID NVARCHAR(50) NOT NULL, EmployeeID NVARCHAR(20),
    Amount DECIMAL(12, 2) NOT NULL, PreviousBalance DECIMAL(12, 2) DEFAULT 0, NewBalance DECIMAL(12, 2) DEFAULT 0,
    TxnType NVARCHAR(20) NOT NULL, RuleID INT REFERENCES Subsidy_Rules(RuleID),
    PerformedBy NVARCHAR(50), Remark NVARCHAR(255)
);

CREATE TABLE Promo_Cashier_Campaigns (
    CampaignID INT IDENTITY(1,1) PRIMARY KEY, CampaignName NVARCHAR(100), StartDate DATETIME, EndDate DATETIME,
    MinTopUpAmount DECIMAL(12,2), CustomerType NVARCHAR(20), RewardType NVARCHAR(20), CalculationType NVARCHAR(20),
    RewardValue DECIMAL(12,2), IsRefundable BIT, ExpireDays INT, IsActive BIT DEFAULT 1, CreatedAt DATETIME
);

CREATE TABLE Promo_Redemption_Log (
    LogID BIGINT IDENTITY(1,1) PRIMARY KEY, TxnID BIGINT, CampaignID INT, CardUID NVARCHAR(50),
    RewardType NVARCHAR(20), RewardAmount DECIMAL(12,2), ExpireDate DATE, RedeemedAt DATETIME
);