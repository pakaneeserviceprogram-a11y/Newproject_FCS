‡∏ó‡∏≥ document ‡πÉ‡∏´‡πâ‡∏î‡πâ‡∏ß‡∏¢

‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô ‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Database, Logic ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô, ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£, ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏°‡∏≤‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ (System Specification Document) ‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö

‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Copy ‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå FCS_System_Spec.md ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏° Developer ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö

Markdown
# üìò FCS Modern Database Specification
**Project Name:** Modern Food Court System (FCS)  
**Version:** 2.0 (Full Integrated)  
**Last Updated:** 2026-01-22  
**Author:** Pakanee & System Architect

---

## 1. üèóÔ∏è System Architecture & Diagrams
‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å

### 1.1 Core Business & Transactions (‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô)
‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á ‡∏ö‡∏±‡∏ï‡∏£ (Cards) -> ‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢ (Sales) -> ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Inventory)

```mermaid
erDiagram
    %% Master Data
    Card_Groups ||--o{ Cards : "defines price tier"
    Employees ||--o{ Cards : "owns"
    Vendors ||--o{ Products : "sells"
    Products ||--o{ Product_Price_Tiers : "has special price"
    Card_Groups ||--o{ Product_Price_Tiers : "receives special price"

    %% Transaction
    Cards ||--o{ Txn_Cashier : "topup/refund"
    Cards ||--o{ Sales_Orders : "purchases"
    Txn_Cashier ||--|{ Txn_Cashier_Payments : "paid by"
    Sales_Orders ||--|{ Sales_Order_Items : "contains"
    
    %% Promotion & Welfare
    Subsidy_Rules ||--o{ Txn_Subsidy_Log : "triggers"
    Cards ||--o{ Txn_Subsidy_Log : "audit trail"
    Promo_Cashier_Campaigns ||--o{ Promo_Redemption_Log : "rewards"
1.2 Security & Back Office (‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)
‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á User, Role ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏°‡∏ô‡∏π

Code snippet
erDiagram
    App_Users ||--|{ App_User_Roles : "has"
    App_Roles ||--|{ App_Role_Permissions : "has"
    App_Permissions ||--|{ App_Role_Permissions : "assigned to"
    App_Permissions ||--o{ App_Menus : "controls visibility"
    App_Menus ||--o{ App_Menus : "parent of"
2. üóÑÔ∏è Database Installation Scripts (SQL)
‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö Step 1-4)

Step 1: Create Database & Tables (Master & Transaction)
SQL
CREATE DATABASE FCS_ModernDB COLLATE Thai_CI_AS;
GO
USE FCS_ModernDB;
GO

/* --- PART 1: MASTER DATA --- */
CREATE TABLE Terminals (
    TerminalID NVARCHAR(20) PRIMARY KEY, TerminalName NVARCHAR(100), TerminalType NVARCHAR(20),
    MachineSerialNo NVARCHAR(50) NOT NULL, POS_Reg_No NVARCHAR(50), LocationCode NVARCHAR(20),
    IsActive BIT DEFAULT 1, CreatedAt DATETIME DEFAULT GETDATE()
);

CREATE TABLE Vendors (
    VendorID NVARCHAR(20) PRIMARY KEY, VendorName NVARCHAR(100) NOT NULL, OwnerName NVARCHAR(100),
    TaxID NVARCHAR(20), BranchID NVARCHAR(10) DEFAULT '00000', IsVatRegistered BIT DEFAULT 0,
    GP_Share_Percent DECIMAL(5, 2) DEFAULT 0.00, Rent_Price DECIMAL(12, 2) DEFAULT 0.00, IsActive BIT DEFAULT 1
);

CREATE TABLE Employees (
    EmployeeID NVARCHAR(20) PRIMARY KEY, FullName NVARCHAR(150) NOT NULL, Department NVARCHAR(100),
    Status NVARCHAR(20) DEFAULT 'Active', ExtraData NVARCHAR(MAX), UpdatedAt DATETIME DEFAULT GETDATE()
);

CREATE TABLE Card_Groups (
    CardGroupID NVARCHAR(20) PRIMARY KEY, GroupName NVARCHAR(100), IsDefault BIT DEFAULT 0
);

CREATE TABLE Cards (
    CardUID NVARCHAR(50) PRIMARY KEY, 
    EmployeeID NVARCHAR(20) REFERENCES Employees(EmployeeID),
    CardGroupID NVARCHAR(20) DEFAULT 'VISITOR' REFERENCES Card_Groups(CardGroupID),
    CashBalance DECIMAL(12, 2) DEFAULT 0.00,       -- ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏≠‡∏á (‡∏ñ‡∏≠‡∏ô‡πÑ‡∏î‡πâ)
    SubsidyBalance DECIMAL(12, 2) DEFAULT 0.00,    -- ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£ (‡∏ñ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
    Status NVARCHAR(20) DEFAULT 'Active', ExpireDate DATE NULL,
    PointBalance DECIMAL(12, 2) DEFAULT 0.00, PointExpDate DATE
);

CREATE TABLE Products (
    ProductID NVARCHAR(20) PRIMARY KEY, VendorID NVARCHAR(20) REFERENCES Vendors(VendorID),
    ProductName NVARCHAR(150) NOT NULL, BasePrice DECIMAL(12, 2) NOT NULL DEFAULT 0,
    StockType NVARCHAR(20) DEFAULT 'STOCK', IsActive BIT DEFAULT 1
);

CREATE TABLE Product_Price_Tiers (
    TierID BIGINT IDENTITY(1,1) PRIMARY KEY,
    ProductID NVARCHAR(20) REFERENCES Products(ProductID),
    CardGroupID NVARCHAR(20) REFERENCES Card_Groups(CardGroupID),
    SpecialPrice DECIMAL(12, 2) NOT NULL,
    CONSTRAINT UK_Product_Tier UNIQUE (ProductID, CardGroupID)
);

CREATE TABLE Ref_Payment_Types (
    PaymentTypeID NVARCHAR(20) PRIMARY KEY, PaymentName NVARCHAR(50), NeedRefNo BIT DEFAULT 0
);

/* --- PART 2: TRANSACTIONS --- */
CREATE TABLE System_Shifts (
    ShiftID INT IDENTITY(1,1) PRIMARY KEY, ShiftDate DATE DEFAULT CAST(GETDATE() AS DATE),
    TerminalID NVARCHAR(20) REFERENCES Terminals(TerminalID), OpenedBy NVARCHAR(50),
    OpenedAt DATETIME DEFAULT GETDATE(), ClosedAt DATETIME NULL, Status NVARCHAR(20) DEFAULT 'Open'
);

CREATE TABLE Txn_Cashier (
    TxnID BIGINT IDENTITY(1,1) PRIMARY KEY, TxnDate DATETIME DEFAULT GETDATE(),
    ShiftID INT REFERENCES System_Shifts(ShiftID), TerminalID NVARCHAR(20) REFERENCES Terminals(TerminalID),
    MachineSerialNo NVARCHAR(50), POS_Reg_No NVARCHAR(50), IssuerTaxID NVARCHAR(20), TaxInvoiceNo NVARCHAR(50), IsFullTax BIT DEFAULT 0,
    CardUID NVARCHAR(50) REFERENCES Cards(CardUID), TxnType NVARCHAR(20) NOT NULL,
    TotalAmount DECIMAL(12, 2) NOT NULL, CashierUserID NVARCHAR(50), Remark NVARCHAR(255)
);

CREATE TABLE Txn_Cashier_Payments (
    PaymentID BIGINT IDENTITY(1,1) PRIMARY KEY, TxnID BIGINT REFERENCES Txn_Cashier(TxnID),
    PaymentTypeID NVARCHAR(20) REFERENCES Ref_Payment_Types(PaymentTypeID),
    Amount DECIMAL(12, 2) NOT NULL, RefNo NVARCHAR(100), RefData NVARCHAR(MAX)
);

CREATE TABLE Sales_Orders (
    OrderID BIGINT IDENTITY(1,1) PRIMARY KEY, OrderNo NVARCHAR(30), OrderDate DATETIME DEFAULT GETDATE(),
    ShiftID INT REFERENCES System_Shifts(ShiftID), TerminalID NVARCHAR(20) REFERENCES Terminals(TerminalID),
    MachineSerialNo NVARCHAR(50), VendorID NVARCHAR(20) REFERENCES Vendors(VendorID),
    IssuerTaxID NVARCHAR(20), TaxInvoiceNo NVARCHAR(50),
    CardUID NVARCHAR(50) REFERENCES Cards(CardUID), TotalAmount DECIMAL(12, 2) NOT NULL,
    VatAmount DECIMAL(12, 2) DEFAULT 0, CashUsed DECIMAL(12, 2) DEFAULT 0, SubsidyUsed DECIMAL(12, 2) DEFAULT 0,
    Status NVARCHAR(20) DEFAULT 'Completed'
);

CREATE TABLE Sales_Order_Items (
    ItemID BIGINT IDENTITY(1,1) PRIMARY KEY, OrderID BIGINT REFERENCES Sales_Orders(OrderID),
    ProductID NVARCHAR(20) REFERENCES Products(ProductID), ProductName_Log NVARCHAR(150),
    Quantity INT DEFAULT 1, UnitPrice DECIMAL(12, 2), TotalPrice AS (Quantity * UnitPrice) PERSISTED
);
Step 2: Create Security & Welfare Tables
SQL
/* --- PART 3: SECURITY & BACK OFFICE --- */
CREATE TABLE App_Permissions (
    PermissionCode NVARCHAR(50) PRIMARY KEY, Description NVARCHAR(100), Category NVARCHAR(50)
);

CREATE TABLE App_Roles (
    RoleID INT IDENTITY(1,1) PRIMARY KEY, RoleName NVARCHAR(50) UNIQUE, Description NVARCHAR(100), IsSystemRole BIT DEFAULT 0
);

CREATE TABLE App_Role_Permissions (
    RoleID INT REFERENCES App_Roles(RoleID), PermissionCode NVARCHAR(50) REFERENCES App_Permissions(PermissionCode),
    PRIMARY KEY (RoleID, PermissionCode)
);

CREATE TABLE App_Users (
    UserID INT IDENTITY(1,1) PRIMARY KEY, Username NVARCHAR(50) UNIQUE, IsADUser BIT DEFAULT 0,
    PasswordHash NVARCHAR(255), RelatedVendorID NVARCHAR(20), IsActive BIT DEFAULT 1
);

CREATE TABLE App_User_Roles (
    UserID INT REFERENCES App_Users(UserID), RoleID INT REFERENCES App_Roles(RoleID), PRIMARY KEY (UserID, RoleID)
);

CREATE TABLE App_Menus (
    MenuID INT IDENTITY(1,1) PRIMARY KEY, ParentMenuID INT REFERENCES App_Menus(MenuID),
    MenuName_TH NVARCHAR(100), MenuName_EN NVARCHAR(100), IconClass NVARCHAR(50),
    RoutePath NVARCHAR(100), SortOrder INT DEFAULT 0,
    RequiredPermissionCode NVARCHAR(50) REFERENCES App_Permissions(PermissionCode), IsActive BIT DEFAULT 1
);

/* --- PART 4: WELFARE & PROMOTION --- */
CREATE TABLE Subsidy_Rules (
    RuleID INT IDENTITY(1,1) PRIMARY KEY, RuleName NVARCHAR(100) NOT NULL,
    CardGroupID NVARCHAR(20) REFERENCES Card_Groups(CardGroupID), -- ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Group ‡∏Å‡πà‡∏≠‡∏ô Insert
    FrequencyType NVARCHAR(20) DEFAULT 'DAILY', ExecutionDay INT DEFAULT 0,
    Amount DECIMAL(12, 2) NOT NULL, TopUpMode NVARCHAR(20) DEFAULT 'RESET', -- RESET=‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡∏°‡πà, STACK=‡∏ó‡∏ö‡∏¢‡∏≠‡∏î
    IsActive BIT DEFAULT 1, LastRunDate DATE NULL
);

CREATE TABLE Txn_Subsidy_Log (
    LogID BIGINT IDENTITY(1,1) PRIMARY KEY, TxnDate DATETIME DEFAULT GETDATE(),
    CardUID NVARCHAR(50) NOT NULL, EmployeeID NVARCHAR(20),
    Amount DECIMAL(12, 2) NOT NULL, PreviousBalance DECIMAL(12, 2) DEFAULT 0, NewBalance DECIMAL(12, 2) DEFAULT 0,
    TxnType NVARCHAR(20) NOT NULL, RuleID INT REFERENCES Subsidy_Rules(RuleID),
    PerformedBy NVARCHAR(50), Remark NVARCHAR(255)
);

CREATE TABLE Promo_Cashier_Campaigns (
    CampaignID INT IDENTITY(1,1) PRIMARY KEY, CampaignName NVARCHAR(100), StartDate DATETIME, EndDate DATETIME,
    MinTopUpAmount DECIMAL(12,2), CustomerType NVARCHAR(20), RewardType NVARCHAR(20), CalculationType NVARCHAR(20),
    RewardValue DECIMAL(12,2), IsRefundable BIT, ExpireDays INT, IsActive BIT DEFAULT 1, CreatedAt DATETIME
);

CREATE TABLE Promo_Redemption_Log (
    LogID BIGINT IDENTITY(1,1) PRIMARY KEY, TxnID BIGINT, CampaignID INT, CardUID NVARCHAR(50),
    RewardType NVARCHAR(20), RewardAmount DECIMAL(12,2), ExpireDate DATE, RedeemedAt DATETIME
);
Step 3: Seed Data (Initial Configuration) ‚úÖ
‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error Foreign Key

SQL
/* 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£ (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Subsidy Rules) */
INSERT INTO Card_Groups (CardGroupID, GroupName, IsDefault) VALUES 
('VISITOR', '‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', 1),
('STAFF',   '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥', 0),
('VIP',     '‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£', 0);

/* 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Roles & Permissions */
INSERT INTO App_Roles (RoleName, IsSystemRole) VALUES ('SystemAdmin', 1), ('Cashier', 0), ('VendorOwner', 0);

INSERT INTO App_Permissions (PermissionCode, Description, Category) VALUES
('POS_VIEW', '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ POS', 'Terminal'),
('VENDOR_VIEW', '‡∏î‡∏π‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤', 'Vendor'),
('EMP_VIEW', '‡∏î‡∏π‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'Employee'),
('CARD_VIEW', '‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£', 'Card');

/* 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏≥‡∏ó‡∏≤‡∏á */
INSERT INTO App_Menus (MenuName_TH, RoutePath, RequiredPermissionCode) VALUES 
('‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤', '/vendors', 'VENDOR_VIEW'),
('‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', '/employees', 'EMP_VIEW');

/* 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á User Admin */
INSERT INTO App_Users (Username, IsActive) VALUES ('admin', 1);
3. ‚öôÔ∏è Business Logic (Stored Procedures)
Logic ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö

3.1 ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Auto Subsidy)
Usage: ‡∏ï‡∏±‡πâ‡∏á Schedule ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô SP ‡∏ô‡∏µ‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô (00:01 ‡∏ô.)

SQL
CREATE PROCEDURE Sp_Subsidy_Process_AutoRules
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @Today DATE = CAST(GETDATE() AS DATE);
    DECLARE @DayOfMonth INT = DAY(@Today);

    DECLARE @RuleCursor CURSOR;
    DECLARE @RuleID INT, @CardGroup NVARCHAR(20), @Amt DECIMAL(12,2), @Mode NVARCHAR(20), @RuleName NVARCHAR(100);

    -- ‡∏î‡∏∂‡∏á‡∏Å‡∏é‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    SET @RuleCursor = CURSOR FOR
    SELECT RuleID, RuleName, CardGroupID, Amount, TopUpMode
    FROM Subsidy_Rules
    WHERE IsActive = 1 AND (LastRunDate IS NULL OR LastRunDate < @Today)
      AND (FrequencyType = 'DAILY' OR (FrequencyType = 'MONTHLY' AND ExecutionDay = @DayOfMonth));

    OPEN @RuleCursor;
    FETCH NEXT FROM @RuleCursor INTO @RuleID, @RuleName, @CardGroup, @Amt, @Mode;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        BEGIN TRANSACTION
        BEGIN TRY
            -- 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
            INSERT INTO Txn_Subsidy_Log (CardUID, EmployeeID, Amount, PreviousBalance, NewBalance, TxnType, RuleID, PerformedBy, Remark)
            SELECT C.CardUID, C.EmployeeID, @Amt, C.SubsidyBalance,
                CASE WHEN @Mode = 'RESET' THEN @Amt ELSE C.SubsidyBalance + @Amt END,
                'AUTO', @RuleID, 'SYSTEM', 'Auto Rule: ' + @RuleName
            FROM Cards C WHERE C.CardGroupID = @CardGroup AND C.Status = 'Active';

            -- 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ Subsidy
            IF @Mode = 'RESET' -- ‡∏•‡πâ‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏Å‡πà‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏´‡πâ‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 50)
                UPDATE Cards SET SubsidyBalance = @Amt WHERE CardGroupID = @CardGroup AND Status = 'Active';
            ELSE -- ‡∏ó‡∏ö‡∏¢‡∏≠‡∏î (‡∏™‡∏∞‡∏™‡∏°‡πÑ‡∏î‡πâ)
                UPDATE Cards SET SubsidyBalance = SubsidyBalance + @Amt WHERE CardGroupID = @CardGroup AND Status = 'Active';

            -- 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏é
            UPDATE Subsidy_Rules SET LastRunDate = @Today WHERE RuleID = @RuleID;

            COMMIT TRANSACTION
        END TRY
        BEGIN CATCH
            ROLLBACK TRANSACTION;
        END CATCH
        FETCH NEXT FROM @RuleCursor INTO @RuleID, @RuleName, @CardGroup, @Amt, @Mode;
    END
    CLOSE @RuleCursor; DEALLOCATE @RuleCursor;
END
GO
3.2 ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô (Cashier Promotion)
Usage: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏Ñ‡∏ä‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡πå‡∏Å‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°

SQL
CREATE PROCEDURE Sp_Cashier_ApplyPromo
    @TxnID BIGINT, @TopUpAmount DECIMAL(12,2), @CardUID NVARCHAR(50)
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @BonusAmt DECIMAL(12,2) = 0;
    DECLARE @PointsAmt DECIMAL(12,2) = 0;

    -- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
    SELECT TOP 1 
        @BonusAmt = CASE WHEN RewardType = 'CASH_BONUS' THEN RewardValue ELSE 0 END,
        @PointsAmt = CASE WHEN RewardType = 'POINT' THEN RewardValue ELSE 0 END
    FROM Promo_Cashier_Campaigns
    WHERE IsActive = 1 AND GETDATE() BETWEEN StartDate AND EndDate AND @TopUpAmount >= MinTopUpAmount
    ORDER BY MinTopUpAmount DESC;

    -- ‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    IF @BonusAmt > 0
    BEGIN
        UPDATE Cards SET SubsidyBalance = SubsidyBalance + @BonusAmt WHERE CardUID = @CardUID; -- ‡πÄ‡∏Ç‡πâ‡∏≤ Subsidy (‡∏ñ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
        INSERT INTO Promo_Redemption_Log (TxnID, CardUID, RewardType, RewardAmount) VALUES (@TxnID, @CardUID, 'CASH_BONUS', @BonusAmt);
    END

    IF @PointsAmt > 0
    BEGIN
        UPDATE Cards SET PointBalance = PointBalance + @PointsAmt WHERE CardUID = @CardUID;
        INSERT INTO Promo_Redemption_Log (TxnID, CardUID, RewardType, RewardAmount) VALUES (@TxnID, @CardUID, 'POINT', @PointsAmt);
    END
END
GO